<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>flowChart</title>
    <!-- <link rel="stylesheet" type="text/css" href="css/style.css" /> -->
	<link type="text/css" href="css/Semantic-UI-CSS-master/semantic.min.css" rel="stylesheet">
	<link type="text/css" href="css/graph-creator.css" rel="stylesheet" />
	<link type="text/css" href="css/flow_zyl.css"  rel="stylesheet"/>
	<link type="text/css" href="css/jquery.mCustomScrollbar.css" rel="stylesheet">
</head>
<body>
	<div class="subheader editor-toolbar">
		<div class="column pop-btn" data-content="保存" data-position="bottom center" data-variation="mini"><i class="save icon"></i></div>
		<div class="divider"></div>
		<div class="column pop-btn" data-content="剪切" data-position="bottom center" data-variation="mini"><i class="cut icon"></i></div>
		<div class="column pop-btn" data-content="复制" data-position="bottom center" data-variation="mini"><i class="copy icon"></i></div>
		<div class="column pop-btn" data-content="粘贴" data-position="bottom center" data-variation="mini"><i class="paste icon"></i></div>
		<div class="column pop-btn" id="delete-graph" data-content="清空" data-position="bottom center" data-variation="mini"><i class="trash icon"></i></div>
		<div class="divider"></div>
		<div class="column pop-btn" data-content="撤销" data-position="bottom center" data-variation="mini"><i class="repeat icon"></i></div>
		<div class="column pop-btn" data-content="恢复" data-position="bottom center" data-variation="mini"><i class="undo icon"></i></div>
		<div class="divider"></div>
		<div class="column pop-btn" data-content="放大" data-position="bottom center" data-variation="mini"><i class="zoom icon"></i></div>
		<div class="column pop-btn" data-content="缩小" data-position="bottom center" data-variation="mini"><i class="zoom out icon"></i></div>
		<div class="column pop-btn" id="reset-zoom" data-content="归位" data-position="bottom center" data-variation="mini"><i class="maximize icon"></i></div>
		<div class="divider"></div>
		<div class="column pop-btn" data-content="导入json" data-position="bottom center" data-variation="mini"><i class="sign in icon"></i></div>
		<div class="column pop-btn small popup" data-content="导出json" data-position="bottom center" data-variation="mini"><i class="sign out icon"></i></div>
	</div>
	<div class="full">
		<div id="flowComponents" class="full-left">
			<div class="components-btn noComponent selectBtn" name="selectBtn">
				<img src="icons/activity/select.png"><span>选择</span>
			</div>
			<div class="clearfix"></div>
			<div class="components-btn" name="startComponent" type="start" for-name="circle">
				<img id="img" src="icons/startevent/none.png"/><span>开始</span>
			</div>
			<div class="clearfix"></div>
			<div class="components-btn" name="endComponent" type="end" for-name="circle">
				<img src="icons/endevent/none.png"><span>结束</span>
			</div>
			<div class="clearfix"></div>
			<div class="components-btn" name="activityComponent" type="activity" for-name="rect">
				<img src="icons/activity/list/type.user.png"><span>普通活动</span>
			</div>
			<div class="clearfix"></div>
			<div class="components-btn" name="blockActivity" type="activity" for-name="">
				<img src="icons/activity/task.png"><span>块活动</span>
			</div>
			<div class="clearfix"></div>
			<div class="components-btn" name="subFlowActivity" type="activity" for-name="">
				<img src="icons/activity/event.subprocess.png"><span>子活动</span>
			</div>
			<div class="clearfix"></div>
			<div class="components-btn" name="routeActivity" type="activity" for-name="">
				<img src="icons/activity/list/type.receive.png"><span>路径活动</span>
			</div>
			<div class="clearfix"></div>
			<div class="components-btn noComponent" name="drawLineBtn" for-name="line">
				<img src="icons/connector/sequenceflow.png"><span>线</span>
			</div>
			<div class="clearfix"></div>
			
		</div>
		<div class="full-right tab">
		<form id="containerForm" method="post" action="http://localhost:8088/platform/wfdman/insert.do">
			<div id="container" class="ui top attached tab active full-right-top view" data-tab="first">
				<!-- svg -->
			</div>
			<div id="xpdlContainer" class="ui top attached tab view content-div" data-tab="second">
				<xmp>
					<!-- xpdl -->
				</xmp>
			</div>
			<div id="xmlContainer" class="ui top attached tab view content-div" data-tab="third">
				<xmp>
					<!-- xml -->
				</xmp>
			</div>
			<div class="full-right-btn ui bottom attached tabular menu">
				<a class="item active" data-tab="first">图标视图</a>
				<a class="item" data-tab="second">xpdl视图</a>
				<a class="item" data-tab="third">xml视图</a>
			</div>
			<div id="propertiesWrapper" class="full-right-bottom">
				<div class="component-name"><i class="angle double down icon"></i><span>普通活动</span></div>
				<div class="component-prop content-div">
					<!-- activity属性 -->
				</div>
			</div>

			<input name="xpdlcontent" type="hidden" value="">
			<input name="xmlcontent" type="hidden" value="">

			<input type="hidden" id="wFID" name="wFID" value="">
			<input type="hidden" id="wFType" name="wFType" value="money">
			<input type="hidden" id="subType" name="subType" value="">
			<input type="hidden" id="depart" name="depart" value="">
			<input type="hidden" id="departID" name="departID" value="">
			<input type="hidden" id="formName" name="formName" value="">
			<input type="hidden" id="formId" name="formId" value="">
			<input type="hidden" id="formType" name="formType" value="wfd_form">
			<input type="hidden" id="mode" name="mode" value="">
			<input type="hidden" id="dt" name="dt" onFocus="WdatePicker({dateFmt:'dd HH:mm',skin:'blue'});" value="">
			<input type="hidden" id="dataObjectID" name="dataObjectID" value="">
			<input type="hidden" id="securityID" name="securityID" value="">
			<input type="hidden" id="securityName" name="securityName" value="">
			<input type="hidden" id="orderNo" name="orderNo" value="">
		</form>
		</div>
		<div class="clearfix"></div>
	</div>
	<!-- 导入导出弹出层 -->
	<div class="ui small modal json_data">
	  	<i class="close icon"></i>
	  	<div class="header">
	   		导入数据
	  	</div>
	  	<div class="content">
	    	<textarea></textarea>
	  	</div>
	  	<div class="actions">
	      	<div class="ui negative button">No </div>
	      	<div class="ui positive right labeled icon button">Yes <i class="checkmark icon"></i> </div>
	    </div>
	</div>
	<!-- 右键菜单 -->
	<div id="rMenu" class="ui vertical mini menu">
		<a class="item" name="removeMenu">删除<i class="remove icon"></i></a>
		<a class="item" name="toFront">置前<i class="object ungroup icon"></i></a>
	</div>

	<script type="text/javascript" src="js/jquery.min.js" charset="utf-8"></script>
	<script type="text/javascript" src="js/common.js" charset="utf-8"></script>
	<script type="text/javascript" src="js/d3.v3.js" charset="utf-8"></script>
	<script type="text/javascript" src="js/juicer-min.js" charset="utf-8"></script>
	<script type="text/javascript" src="js/semantic/semantic.js" charset="utf-8"></script>
	<script type="text/javascript" src="js/jquery.mCustomScrollbar.concat.min.js" charset="utf-8"></script>
	<script type="text/javascript" src="js/vkbeautify.js" charset="utf-8"></script>
	<script type="text/javascript" src="js/svg.js" charset="utf-8"></script>
	<script type="text/javascript" src="js/flowchart_zyl.js" charset="utf-8"></script>
	
	<script>
		juicer.set({  
			'tag::operationOpen': '{@',  
			'tag::operationClose': '}',  
			'tag::interpolateOpen': '{{=',  
			'tag::interpolateClose': '}}'  
		});  
	</script>

	<script id="tpl" type="text/template"><!-- 可以通过模板生成activity，暂时没用 -->
	    <activity Id="{{=activity.id}}" Name="{{=activity.title}}" form-id="" formdisplayschema="" hisformdisplayschema="">
	        <operations/>
	        <text-limit/>
	    </activity>
	</script>

	<script>
		var Word = randomWord(false, 8);
		var workflow_name = '过程';
		var workflow_id = 'Package_' + Word + '_Wor1';
		var activitySets = workflow_id + 'Ase1';
		var package_id = workflow_id.substring(0, workflow_id.lastIndexOf('_'));
		var creat_time = new Date().pattern("yyyy-MM-dd HH:mm:ss");
		var svg_ns = "http://www.w3.org/2000/svg";
		var mySvg;
		var initParameter = { //初始化shape参数
				circle: 'cx:100,cy:100,r:20',
				rect: 'x:177,y:49,width:80,height:50',
				line: 'x1:550,y1:50,x2:650,y2:150'
			};
		var commonParameter = 'stroke:#AA99FF,stroke-width:2,fill:none'; //shape共同参数
	
		$(function(){
			$('#container').on('click', '.component span', function(){
				alert("component被点击");
			});
			
			//编辑工具(保存)
			$('.editor-toolbar .icon.save').on('click', function(){
				var dataTab = $('.full-right-btn .item.active').attr('data-tab');
				$('.full-right-btn .item').not($('.full-right-btn .item.active')).trigger('click');//触发点击事件获取xpdl和xml
				$('.full-right-btn .item[data-tab="'+dataTab+'"]').trigger('click');
				var xpdl = $('#xpdlContainer xmp').text();
				var xml = $('#xmlContainer xmp').text();
				var xpdl_top =
					'<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n'+
				    '<Package xmlns="http://www.wfmc.org/2002/XPDL1.0" xmlns:xpdl="http://www.wfmc.org/2002/XPDL1.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" Id="'+package_id+'" Name="新包" xsi:schemaLocation="http://www.wfmc.org/2002/XPDL1.0 http://wfmc.org/standards/dtd/TC-1025_schema_10_xpdl.xsd">\n'+
				    '    <PackageHeader>'+
				    '        <XPDLVersion>1.0</XPDLVersion>'+
				    '        <Vendor>GENTLESOFT</Vendor>'+
				    '        <Created>'+creat_time+'</Created>'+
				    '    </PackageHeader>'+
				    '    <RedefinableHeader PublicationStatus="UNDER_TEST">'+
				    '        <Author>管理员</Author>'+
				    '        <Version>1.0</Version>'+
				    '    </RedefinableHeader>'+
				    '    <ConformanceClass GraphConformance="NON_BLOCKED"/>'+
				    '    <Script Type="text/javascript"/>'+
				    '    <DataFields>'+
				    '        <DataField Id="sourceReferenceId" IsArray="FALSE" Name="sourceReferenceId">'+
				    '            <DataType>'+
				    '                <BasicType Type="STRING"/>'+
				    '            </DataType>'+
				    '            <InitialValue>null</InitialValue>'+
				    '        </DataField>'+
				    '        <DataField Id="formId" IsArray="FALSE" Name="formId">'+
				    '            <DataType>'+
				    '                <BasicType Type="STRING"/>'+
				    '            </DataType>'+
				    '            <InitialValue>null</InitialValue>'+
				    '        </DataField>'+
				    '        <DataField Id="nextActivityInfo" IsArray="FALSE" Name="nextActivityInfo">'+
				    '            <DataType>'+
				    '                <ExternalReference location="org.gentlesoft.wf.NextActivitiesParty"/>'+
				    '            </DataType>'+
				    '            <InitialValue>null</InitialValue>'+
				    '        </DataField>'+
				    '        <DataField Id="nextActivityName" IsArray="FALSE" Name="nextActivityName">'+
				    '            <DataType>'+
				    '                <ExternalReference location="java.util.ArrayList"/>'+
				    '            </DataType>'+
				    '            <InitialValue>null</InitialValue>'+
				    '        </DataField>'+
				    '        <DataField Id="formType" IsArray="FALSE" Name="formType">'+
				    '            <DataType>'+
				    '                <BasicType Type="STRING"/>'+
				    '            </DataType>'+
				    '            <InitialValue>null</InitialValue>'+
				    '        </DataField>'+
				    '    </DataFields>';
				var xpdl_end = 
					'    <ExtendedAttributes>'+
				    '        <ExtendedAttribute Name="MadeBy" Value="com.gentlesoft.tools.wfd"/>'+
				    '        <ExtendedAttribute Name="Version" Value="1.4.2"/>'+
				    '    </ExtendedAttributes>'+
				    '</Package>';
				var xml_top = '<?xml version="1.0" encoding="UTF-8"?><pkg-config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" Id="'+package_id+'" Name="新包" Version="" xsi:noNamespaceSchemaLocation="../dtd/flowactconfig.xsd">';
				var xml_end = '</pkg-config>';
				xpdl = vkbeautify.xml(xpdl_top + xpdl + xpdl_end);
				xml = vkbeautify.xml(xml_top + xml + xml_end);
				$('input[name="xpdlcontent"]').val(xpdl);
				$('input[name="xmlcontent"]').val(xpdl);
				/*
				console.log('xpdl:');
				console.log(xpdl);
				console.log('xml:');
				console.log(xml);*/
				$('#containerForm').submit();
				
			});
			//控制属性显示
			$('.component-name').on('click', function(){
				if ($('.component-prop').is(':hidden')) {
					$('.full-right-bottom ').css({height: '30%'});
					$('.view').css({height: '65%'});
					$('.component-name .icon').removeClass('up').addClass('down');
					$('.component-prop').toggle('slow');
				}else{
					$('.full-right-bottom ').css({height: '8%'});
					$('.view').css({height: '87%'});
					$('.component-name .icon').removeClass('down').addClass('up');
					$('.component-prop').toggle();
				}
			});
			//选择左侧工具
			$('#flowComponents .components-btn').on('click', function(){
				$(this).siblings().removeClass('active').end().addClass('active');
				if('drawLineBtn'==$(this).attr('name')){
					$('#container').on('mouseover mouseout', '.conceptG', function(){
						if(event.type == 'mouseover'){
	        				this.style.cursor = 'crosshair';
	     				}else if(event.type == 'mouseout'){
	        				this.style.cursor = 'default';
	      				}
					});
				}else{
					$('#container').off('mouseover mouseout', '.conceptG');
				}
			});
			//右击点击
			$('#container svg .graph').on('contextmenu', function(){
				$('#flowComponents div[name="selectBtn"]').trigger('click');
				$('#container .conceptG').css('cursor', 'default');//防止在活动块上右击存在问题
				$("#rMenu").css({"top":(event.clientY-13)+"px", "left":event.clientX+"px"});
				$("#rMenu").show();
				return false;
			})
			$('svg').on('click', function(){
				$('#rMenu').hide();
			});
			$('svg').on('contextmenu', function(){
				$('#flowComponents div[name="selectBtn"]').trigger('click');
				return false;
			});
		})
	    
	</script>
	<script>
		$(function(){
			var initProp = '<div>'+
								'<div name="id" class="prop-value"><span>id:</span><span>'+workflow_id+'</span></div>'+
								'<div name="name" class="prop-value"><span>名称:</span><span>'+workflow_name+'</span></div>'+
							'</div>'+
							'<div class="clearfix"></div>';
			$('.component-prop').append(initProp);
			$('.component-name span').text(workflow_name);
			$('.menu .item').tab();//标签显示必须放updateScrollbar之前

			$('.menu .item').on('click', updateScrollbar);
		})
		
		$(function(){
			//semantic初始化
			$('.pop-btn').popup();
			//jquery插件滚动条
			$(".content-div").mCustomScrollbar();
		})

		function updateScrollbar(){
			var dataTab = $(this).attr('data-tab');
			if(dataTab=='third'){ //xml视图
				var customScrollbar=$("#xmlContainer").find(".mCSB_scrollTools");
				// customScrollbar.css({"opacity":0});
				$("#xmlContainer").mCustomScrollbar("update");
				// customScrollbar.animate({opacity:1},"slow");
			}
			if(dataTab=='second'){ //xml视图
				var customScrollbar=$("#xpdlContainer").find(".mCSB_scrollTools");
				$("#xpdlContainer").mCustomScrollbar("update");
			}
		}
	</script>
</body>
</html>